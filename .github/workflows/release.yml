name: Release

on:
  push:
    tags: ['v*']

permissions:
  contents: write
  packages: write

jobs:
  # ─────────────────────────────────────────────────────────────────
  # Job 1: Verify the release is correctly configured BEFORE building
  # ─────────────────────────────────────────────────────────────────
  verify-release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          TAG="${GITHUB_REF_NAME}"
          echo "Tag: $TAG"
          echo "version=$TAG" >> "$GITHUB_OUTPUT"

      - name: Verify compose file references correct version
        run: |
          TAG="${{ steps.version.outputs.version }}"
          echo "Checking docker-compose.customer.yml for VECTORAIZ_VERSION:-${TAG}"
          if ! grep -q "VECTORAIZ_VERSION:-${TAG}" docker-compose.customer.yml; then
            echo ""
            echo "::error::RELEASE BLOCKED — docker-compose.customer.yml does not reference ${TAG}"
            echo ""
            echo "The compose file must contain: VECTORAIZ_VERSION:-${TAG}"
            echo "Actual content:"
            grep "VECTORAIZ_VERSION" docker-compose.customer.yml || echo "(not found)"
            echo ""
            echo "This means release.sh did not update the compose file correctly."
            echo "Fix: update docker-compose.customer.yml, commit, push, delete and re-push the tag."
            exit 1
          fi
          echo "✅ Compose file references ${TAG}"

      - name: Verify install scripts have proper error handling
        run: |
          echo "Checking install-mac.sh has health check gates..."
          
          # Must have HEALTH_OK variable
          if ! grep -q "HEALTH_OK" installers/mac/install-mac.sh; then
            echo "::error::install-mac.sh missing HEALTH_OK health check logic"
            exit 1
          fi
          
          # Must NOT show success banner unconditionally
          # The success banner should only appear inside an if-block checking health
          if grep -B2 "vectorAIz is Installed" installers/mac/install-mac.sh | grep -q "^print_ready"; then
            echo "::error::install-mac.sh calls print_ready unconditionally (outside health check)"
            exit 1
          fi
          
          # Syntax check all shell scripts
          for script in install.sh installers/mac/install-mac.sh installers/linux/install-linux.sh; do
            if [ -f "$script" ]; then
              bash -n "$script" || { echo "::error::Syntax error in $script"; exit 1; }
              echo "✅ $script syntax OK"
            fi
          done
          
          echo "✅ Install scripts have proper error handling"

      - name: Verify Dockerfile.customer exists
        run: |
          if [ ! -f Dockerfile.customer ]; then
            echo "::error::Dockerfile.customer not found"
            exit 1
          fi
          echo "✅ Dockerfile.customer exists"

      - name: Check get.vectoraiz.com reachability
        run: |
          HTTP_CODE=$(curl -o /dev/null -s -w "%{http_code}" -L --max-time 10 https://get.vectoraiz.com 2>/dev/null || echo "000")
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 400 ]; then
            echo "get.vectoraiz.com reachable (HTTP ${HTTP_CODE})"
          else
            echo "::warning::get.vectoraiz.com returned HTTP ${HTTP_CODE} — may be DNS/network issue in CI"
          fi

  # ─────────────────────────────────────────────────────────────────
  # Job 2: Build and push Docker image (only after verification)
  # ─────────────────────────────────────────────────────────────────
  build-push:
    needs: verify-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.customer
          push: true
          tags: |
            ghcr.io/aidotmarket/vectoraiz:${{ needs.verify-release.outputs.version }}
            ghcr.io/aidotmarket/vectoraiz:latest
          build-args: |
            VERSION=${{ needs.verify-release.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

  # ─────────────────────────────────────────────────────────────────
  # Job 3: Smoke test — verify image is pullable and install works
  # ─────────────────────────────────────────────────────────────────
  smoke-test:
    needs: [verify-release, build-push]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Wait for GHCR propagation
        run: sleep 30

      - name: Verify multi-arch manifest (RELEASE GATE)
        run: |
          TAG="${{ needs.verify-release.outputs.version }}"
          echo "Inspecting manifest for ghcr.io/aidotmarket/vectoraiz:${TAG}..."

          MANIFEST=$(docker manifest inspect "ghcr.io/aidotmarket/vectoraiz:${TAG}" 2>&1) || {
            echo "::error::RELEASE BLOCKED — Cannot inspect manifest for ${TAG}"
            echo "$MANIFEST"
            exit 1
          }

          # Check for amd64
          if echo "$MANIFEST" | grep -q '"architecture": "amd64"'; then
            echo "✅ linux/amd64 present"
          else
            echo "::error::RELEASE BLOCKED — linux/amd64 manifest MISSING. Image will not run on Intel/AMD machines."
            exit 1
          fi

          # Check for arm64
          if echo "$MANIFEST" | grep -q '"architecture": "arm64"'; then
            echo "✅ linux/arm64 present"
          else
            echo "::error::RELEASE BLOCKED — linux/arm64 manifest MISSING. Image will not run on Apple Silicon Macs."
            exit 1
          fi

          echo "✅ Multi-arch manifest verified: amd64 + arm64"

      - name: Set up QEMU for arm64 emulation
        uses: docker/setup-qemu-action@v3


      - name: Boot arm64 container via QEMU
        run: |
          TAG="${{ needs.verify-release.outputs.version }}"
          docker pull --platform linux/arm64 "ghcr.io/aidotmarket/vectoraiz:${TAG}"
          
          # Run container briefly — it will exit without postgres/qdrant,
          # but we verify the arm64 binary executes (no exec format error)
          CID=$(docker run -d --platform linux/arm64 "ghcr.io/aidotmarket/vectoraiz:${TAG}")
          sleep 10
          LOGS=$(docker logs "$CID" 2>&1 || true)
          
          # Check entrypoint actually ran (not exec format error)
          if echo "$LOGS" | grep -q "exec format error"; then
            echo "::error::arm64 binary failed — exec format error"
            echo "$LOGS" | tail -20
            docker rm -f "$CID" 2>/dev/null || true
            exit 1
          fi
          
          if echo "$LOGS" | grep -qi "starting\|migration\|vectoraiz"; then
            echo "✅ arm64 container entrypoint executed successfully"
            echo "$LOGS" | tail -10
          else
            echo "::warning::arm64 container produced no recognized output"
            echo "$LOGS" | tail -20
          fi
          docker rm -f "$CID" 2>/dev/null || true

      - name: Verify image is pullable
        run: |
          TAG="${{ needs.verify-release.outputs.version }}"
          echo "Pulling ghcr.io/aidotmarket/vectoraiz:${TAG}..."
          docker pull "ghcr.io/aidotmarket/vectoraiz:${TAG}"
          echo "✅ Image pullable"

      - name: Verify latest tag matches release
        run: |
          TAG="${{ needs.verify-release.outputs.version }}"
          docker pull "ghcr.io/aidotmarket/vectoraiz:latest"
          
          RELEASE_DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' "ghcr.io/aidotmarket/vectoraiz:${TAG}" | cut -d@ -f2)
          LATEST_DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' "ghcr.io/aidotmarket/vectoraiz:latest" | cut -d@ -f2)
          
          echo "Release digest: $RELEASE_DIGEST"
          echo "Latest digest:  $LATEST_DIGEST"
          
          if [ "$RELEASE_DIGEST" != "$LATEST_DIGEST" ]; then
            echo "::warning::latest tag digest does not match ${TAG} — may need time to propagate"
          else
            echo "✅ latest tag matches ${TAG}"
          fi

      - name: Simulate install — verify compose resolves correctly
        run: |
          TAG="${{ needs.verify-release.outputs.version }}"
          
          # Download compose file as the installer would
          curl -fsSL "https://raw.githubusercontent.com/aidotmarket/vectoraiz/main/docker-compose.customer.yml" -o test-compose.yml
          
          if grep -q "VECTORAIZ_VERSION:-${TAG}" test-compose.yml; then
            echo "✅ Install compose resolves to ${TAG}"
          else
            echo "::warning::Compose file on GitHub raw does not yet show ${TAG} (CDN cache)"
            echo "Actual content:"
            grep "VECTORAIZ_VERSION" test-compose.yml
          fi

      - name: Container startup test
        run: |
          TAG="${{ needs.verify-release.outputs.version }}"
          
          # Create minimal .env
          echo "POSTGRES_PASSWORD=testpassword123" > .env
          echo "VECTORAIZ_SECRET_KEY=testsecret123" >> .env
          echo "VECTORAIZ_APIKEY_HMAC_SECRET=testhmac123" >> .env
          echo "VECTORAIZ_PORT=8080" >> .env
          echo "VECTORAIZ_MODE=standalone" >> .env
          echo "VECTORAIZ_IMPORT_DIR=/tmp/vectoraiz-imports" >> .env
          mkdir -p /tmp/vectoraiz-imports
          
          # Start with compose
          docker compose -f docker-compose.customer.yml up -d
          
          # Wait for health (up to 90s)
          echo "Waiting for health check..."
          for i in $(seq 1 30); do
            if curl -sf http://localhost:8080/api/health 2>/dev/null; then
              echo ""
              echo "✅ Container health check passed"
              
              # Verify version in health response
              HEALTH=$(curl -sf http://localhost:8080/api/health)
              echo "Health response: $HEALTH"
              
              docker compose -f docker-compose.customer.yml down -v
              exit 0
            fi
            printf "."
            sleep 3
          done
          
          echo ""
          echo "::error::Container health check failed after 90s"
          echo "--- Container status ---"
          docker compose -f docker-compose.customer.yml ps -a
          echo "--- vectoraiz logs ---"
          docker compose -f docker-compose.customer.yml logs vectoraiz 2>&1 | tail -50
          echo "--- postgres logs ---"
          docker compose -f docker-compose.customer.yml logs postgres 2>&1 | tail -20
          docker compose -f docker-compose.customer.yml down -v
          exit 1

      - name: Run verification suite
        run: |
          TAG="${{ needs.verify-release.outputs.version }}"
          if ! curl -sf http://localhost:8080/api/health 2>/dev/null; then
            docker compose -f docker-compose.customer.yml up -d
            for i in $(seq 1 30); do
              curl -sf http://localhost:8080/api/health 2>/dev/null && break
              sleep 3
            done
          fi
          chmod +x scripts/verify-customer-image.sh
          bash scripts/verify-customer-image.sh "${TAG}" --compose || true
          docker compose -f docker-compose.customer.yml down -v 2>/dev/null || true

  e2e-install-test:
    needs: [verify-release, build-push]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Linux install script end-to-end
        env:
          INSTALL_REF: ${{ github.sha }}
        run: |
          echo "n" | bash installers/linux/install-linux.sh
          
          if [ ! -f "$HOME/vectoraiz/docker-compose.customer.yml" ]; then
            echo "::error::Compose file not downloaded"
            exit 1
          fi
          
          if [ ! -f "$HOME/vectoraiz/.env" ]; then
            echo "::error::.env not generated"
            exit 1
          fi
          
          PORT=$(grep "^VECTORAIZ_PORT=" "$HOME/vectoraiz/.env" | cut -d'=' -f2)
          for i in $(seq 1 40); do
            curl -sf "http://localhost:${PORT}/api/health" 2>/dev/null && break
            sleep 3
          done
          
          if curl -sf "http://localhost:${PORT}/api/health" >/dev/null 2>&1; then
            echo "E2E install test passed"
          else
            echo "::error::Health check failed after install"
            cd "$HOME/vectoraiz" && docker compose -f docker-compose.customer.yml logs --tail=30 2>&1
            exit 1
          fi
          
          cd "$HOME/vectoraiz" && docker compose -f docker-compose.customer.yml down -v 2>/dev/null || true

  # ─────────────────────────────────────────────────────────────────
  # Job 4: Create GitHub Release (only after smoke test passes)
  # ─────────────────────────────────────────────────────────────────
  create-release:
    needs: [verify-release, smoke-test, e2e-install-test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Make installer scripts executable
        run: |
          chmod +x install.sh
          chmod +x installers/mac/install-mac.sh
          chmod +x installers/mac/uninstall-mac.sh
          chmod +x installers/linux/install-linux.sh
          chmod +x installers/linux/uninstall-linux.sh

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            install.sh
            installers/mac/install-mac.sh
            installers/mac/uninstall-mac.sh
            installers/windows/install-vectoraiz.ps1
            installers/windows/uninstall-vectoraiz.ps1
            installers/linux/install-linux.sh
            installers/linux/uninstall-linux.sh
            docker-compose.customer.yml
          generate_release_notes: true
